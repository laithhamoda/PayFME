<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayFME - Facility Management Payments</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for UI -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* Hide number input arrows */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }

        /* Active navigation link style */
        .nav-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
    </style>
</head>
<body class="h-full overflow-hidden">
    <div class="flex h-screen bg-gray-100">

        <!-- Sidebar (Desktop) -->
        <div class="hidden md:flex md:flex-shrink-0">
            <div class="flex w-64 flex-col bg-gray-900 text-white">
                <!-- Sidebar Header -->
                <div class="flex h-16 flex-shrink-0 items-center px-6 border-b border-gray-700">
                    <span class="text-2xl font-bold text-white">Pay<span class="text-indigo-400">FME</span></span>
                </div>
                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto px-4 py-4" id="desktop-nav">
                    <a href="#" data-page="dashboard" class="nav-link active group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="home" class="mr-3 h-5 w-5"></i> Dashboard
                    </a>
                    <a href="#" data-page="invoices" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="file-text" class="mr-3 h-5 w-5"></i> Invoices
                    </a>
                    <a href="#" data-page="contractors" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="users" class="mr-3 h-5 w-5"></i> Contractors
                    </a>
                    <a href="#" data-page="properties" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="briefcase" class="mr-3 h-5 w-5"></i> Properties
                    </a>
                    <a href="#" data-page="reports" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="bar-chart-2" class="mr-3 h-5 w-5"></i> Reports
                    </a>
                </nav>
                <!-- User Account -->
                <div class="border-t border-gray-700 p-4">
                    <div class="flex items-center">
                        <img class="h-10 w-10 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=FM" alt="User Avatar">
                        <div class="ml-3">
                            <p class="text-sm font-medium text-white">Jane Cooper</p>
                            <p class="text-xs font-medium text-gray-400 group-hover:text-gray-300">Facility Manager</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-1 flex-col overflow-y-auto">
            
            <!-- Header (Mobile + Desktop) -->
            <header class="sticky top-0 z-10 flex h-16 flex-shrink-0 items-center justify-between border-b border-gray-200 bg-white px-4 md:px-8">
                <!-- Mobile Menu Button -->
                <button type="button" class="rounded-lg p-2 text-gray-500 hover:bg-gray-100 md:hidden" id="mobile-menu-button">
                    <i data-feather="menu" class="h-6 w-6"></i>
                </button>

                <!-- Header Title (Dynamic) -->
                <h1 id="header-title" class="text-xl font-semibold text-gray-900">Dashboard</h1>
                
                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <button class="rounded-full p-2 text-gray-500 hover:bg-gray-100">
                        <span class="relative">
                            <i data-feather="bell" class="h-6 w-6"></i>
                            <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex h-3 w-3 rounded-full bg-red-500"></span>
                            </span>
                        </span>
                    </button>
                    <!-- CTA Button -->
                    <button type="button" id="new-invoice-btn-header" class="hidden sm:inline-flex items-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <i data-feather="plus" class="mr-2 h-5 w-5"></i>
                        New Invoice
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">

                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                        <div class="overflow-hidden rounded-xl bg-white p-5 shadow-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 rounded-lg bg-red-500 p-3">
                                    <i data-feather="alert-circle" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <p class="truncate text-sm font-medium text-gray-500">Overdue Payments</p>
                                    <p id="kpi-overdue-amount" class="text-2xl font-bold text-gray-900">$0.00</p>
                                    <p id="kpi-overdue-count" class="text-sm text-gray-500">0 invoices</p>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-hidden rounded-xl bg-white p-5 shadow-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 rounded-lg bg-yellow-500 p-3">
                                    <i data-feather="clock" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <p class="truncate text-sm font-medium text-gray-500">Pending Approval</p>
                                    <p id="kpi-pending-amount" class="text-2xl font-bold text-gray-900">$0.00</p>
                                    <p id="kpi-pending-count" class="text-sm text-gray-500">0 invoices</p>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-hidden rounded-xl bg-white p-5 shadow-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 rounded-lg bg-green-500 p-3">
                                    <i data-feather="check-circle" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <p class="truncate text-sm font-medium text-gray-500">Paid (This Month)</p>
                                    <p id="kpi-paid-amount" class="text-2xl font-bold text-gray-900">$0.00</p>
                                    <p id="kpi-paid-count" class="text-sm text-gray-500">0 invoices</p>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-hidden rounded-xl bg-white p-5 shadow-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 rounded-lg bg-indigo-500 p-3">
                                    <i data-feather="users" class="h-6 w-6 text-white"></i>
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <p class="truncate text-sm font-medium text-gray-500">Active Contractors</p>
                                    <p id="kpi-contractors" class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-sm text-gray-500">&nbsp;</p> <!-- for alignment -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Invoices & Quick Actions -->
                    <div class="mt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
                        <!-- Recent Invoices Table -->
                        <div class="lg:col-span-2">
                            <h2 class="text-lg font-semibold text-gray-900">Recent Invoices</h2>
                            <div class="mt-4 overflow-hidden rounded-xl bg-white shadow-lg">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Contractor</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Amount</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Due Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dashboard-invoice-table" class="divide-y divide-gray-200 bg-white">
                                            <!-- JS will populate this -->
                                            <tr><td colspan="4" class="p-6 text-center text-gray-500">No recent invoices.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Actions -->
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Quick Actions</h2>
                            <div class="mt-4 space-y-4">
                                <div class="rounded-xl bg-white p-5 shadow-lg">
                                    <h3 class="font-medium text-gray-900">Communication Hub</h3>
                                    <p class="mt-1 text-sm text-gray-500">Centralize all payment communication.</p>
                                    <div class="mt-4 space-y-3">
                                        <div class="flex items-center">
                                            <i data-feather="message-square" class="h-5 w-5 text-indigo-500"></i>
                                            <span class="ml-2 text-sm text-gray-700">3 Unread Messages</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i data-feather="alert-octagon" class="h-5 w-5 text-red-500"></i>
                                            <span class="ml-2 text-sm text-gray-700">1 Payment Dispute</span>
                                        </div>
                                    </div>
                                    <button class="mt-4 w-full rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200">View All</button>
                                </div>
                                <div class="rounded-xl bg-white p-5 shadow-lg">
                                    <h3 class="font-medium text-gray-900">Solve Inefficiencies</h3>
                                    <p class="mt-1 text-sm text-gray-500">Automate your financial management.</p>
                                    <button class="mt-4 w-full rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">Export Financial Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoices Page -->
                <div id="page-invoices" class="page-content hidden">
                    <!-- Invoice Filters & Actions -->
                    <div class="sm:flex sm:items-center sm:justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <p class="text-sm text-gray-700">Filter by:</p>
                                <select id="invoice-filter" class="rounded-lg border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="all">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Overdue">Overdue</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Declined">Declined</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0">
                            <button type="button" id="new-invoice-btn" class="inline-flex w-full items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 sm:w-auto">
                                <i data-feather="plus" class="mr-2 h-5 w-5"></i>
                                Submit New Invoice
                            </button>
                        </div>
                    </div>

                    <!-- Invoices Table -->
                    <div class="mt-6 overflow-hidden rounded-xl bg-white shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Contractor</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Property</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Description</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Amount</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Due Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-table-body" class="divide-y divide-gray-200 bg-white">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contractors Page -->
                <div id="page-contractors" class="page-content hidden">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="contractors-grid">
                        <!-- JS will populate this -->
                    </div>
                </div>

                <!-- Properties Page -->
                <div id="page-properties" class="page-content hidden">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="properties-grid">
                        <!-- JS will populate this -->
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="page-reports" class="page-content hidden">
                    <div class="rounded-xl bg-white p-8 text-center shadow-lg">
                        <i data-feather="bar-chart-2" class="mx-auto h-16 w-16 text-indigo-500"></i>
                        <h2 class="mt-4 text-2xl font-semibold text-gray-900">Reports Dashboard</h2>
                        <p class="mt-2 text-gray-600">Gain real-time tracking and reporting for clear visibility on all financial activities.</p>
                        <button class="mt-6 rounded-lg bg-indigo-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-indigo-700">
                            Download Q4 Financial Summary
                        </button>
                    </div>
                </div>

            </main>
        </div>

        <!-- Mobile Sidebar -->
        <div class="fixed inset-0 z-40 flex md:hidden" id="mobile-menu" style="display: none;">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75" id="mobile-overlay"></div>
            
            <!-- Sidebar -->
            <div class="relative flex w-64 max-w-xs flex-1 flex-col bg-gray-900 text-white">
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button type="button" class="ml-1 flex h-10 w-10 items-center justify-center rounded-full" id="mobile-menu-close">
                        <i data-feather="x" class="h-6 w-6 text-white"></i>
                    </button>
                </div>
                
                <div class="flex h-16 flex-shrink-0 items-center px-6 border-b border-gray-700">
                    <span class="text-2xl font-bold text-white">Pay<span class="text-indigo-400">FME</span></span>
                </div>
                <nav class="flex-1 overflow-y-auto px-4 py-4" id="mobile-nav">
                    <a href="#" data-page="dashboard" class="nav-link active group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="home" class="mr-3 h-5 w-5"></i> Dashboard
                    </a>
                    <a href="#" data-page="invoices" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="file-text" class="mr-3 h-5 w-5"></i> Invoices
                    </a>
                    <a href="#" data-page="contractors" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="users" class="mr-3 h-5 w-5"></i> Contractors
                    </a>
                    <a href="#" data-page="properties" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="briefcase" class="mr-3 h-5 w-5"></i> Properties
                    </a>
                    <a href="#" data-page="reports" class="nav-link group flex items-center rounded-lg px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">
                        <i data-feather="bar-chart-2" class="mr-3 h-5 w-5"></i> Reports
                    </a>
                </nav>
            </div>
        </div>

        <!-- Invoice Modal -->
        <div id="invoice-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="display: none;">
            <div class="w-full max-w-2xl rounded-xl bg-white shadow-2xl m-4">
                <form id="invoice-form" class="p-6 md:p-8">
                    <div class="flex items-center justify-between">
                        <h2 id="modal-title" class="text-2xl font-semibold text-gray-900">Submit New Invoice</h2>
                        <button type="button" id="modal-close-btn" class="rounded-full p-2 text-gray-400 hover:bg-gray-100">
                            <i data-feather="x" class="h-6 w-6"></i>
                        </button>
                    </div>

                    <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                        <!-- Contractor -->
                        <div>
                            <label for="modal-contractor" class="block text-sm font-medium text-gray-700">Contractor</label>
                            <select id="modal-contractor" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <!-- JS will populate -->
                            </select>
                        </div>
                        <!-- Property -->
                        <div>
                            <label for="modal-property" class="block text-sm font-medium text-gray-700">Property</label>
                            <select id="modal-property" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <!-- JS will populate -->
                            </select>
                        </div>
                        <!-- Amount -->
                        <div>
                            <label for="modal-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <div class="relative mt-1">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" id="modal-amount" placeholder="0.00" class="block w-full rounded-lg border-gray-300 pl-7 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                        <!-- Due Date -->
                        <div>
                            <label for="modal-due-date" class="block text-sm font-medium text-gray-700">Due Date</label>
                            <input type="date" id="modal-due-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <!-- Description -->
                        <div class="md:col-span-2">
                            <label for="modal-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="modal-description" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Emergency plumbing repair, Lobby HVAC maintenance"></textarea>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="modal-cancel-btn" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                            Submit Invoice
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        /**
         * PayFME Application Logic
         * This self-contained script powers the entire MVP dashboard.
         */
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE (Mock Database) ---
            const state = {
                currentPage: 'dashboard',
                contractors: [
                    { id: 'c1', name: 'Alpha Plumbing', specialty: 'Plumbing', phone: '555-1234', email: 'contact@alpha.com', img: 'https://placehold.co/100x100/3B82F6/FFFFFF?text=A' },
                    { id: 'c2', name: 'Bolton Electrical', specialty: 'Electrical', phone: '555-5678', email: 'info@bolton.com', img: 'https://placehold.co/100x100/F59E0B/FFFFFF?text=B' },
                    { id: 'c3', name: 'Creative Landscaping', specialty: 'Landscaping', phone: '555-8765', email: 'team@creative.com', img: 'https://placehold.co/100x100/10B981/FFFFFF?text=C' },
                    { id: 'c4', name: 'Delta HVAC', specialty: 'HVAC', phone: '555-4321', email: 'service@delta.com', img: 'https://placehold.co/100x100/EF4444/FFFFFF?text=D' },
                ],
                properties: [
                    { id: 'p1', name: 'Skyline Towers', address: '123 Main St, Metro City', img: 'https://placehold.co/600x400/6366F1/FFFFFF?text=Skyline+Towers' },
                    { id: 'p2', name: 'Riverfront Plaza', address: '456 Water St, Metro City', img: 'https://placehold.co/600x400/22C55E/FFFFFF?text=Riverfront+Plaza' },
                    { id: 'p3', name: 'The Beacon Lofts', address: '789 Industrial Ave, Metro City', img: 'https://placehold.co/600x400/EC4899/FFFFFF?text=Beacon+Lofts' },
                ],
                invoices: [
                    { id: 'i1', contractorId: 'c1', propertyId: 'p1', amount: 1250.00, status: 'Pending', dueDate: '2025-11-20', description: 'Emergency pipe burst repair, Unit 12B' },
                    { id: 'i2', contractorId: 'c2', propertyId: 'p2', amount: 3200.00, status: 'Approved', dueDate: '2025-11-22', description: 'Main lobby lighting upgrade' },
                    { id: 'i3', contractorId: 'c3', propertyId: 'p1', amount: 800.50, status: 'Paid', dueDate: '2025-11-01', description: 'Monthly groundskeeping' },
                    { id: 'i4', contractorId: 'c4', propertyId: 'p3', amount: 4500.00, status: 'Overdue', dueDate: '2025-11-10', description: 'Rooftop HVAC unit 2 replacement' },
                    { id: 'i5', contractorId: 'c1', propertyId: 'p2', amount: 450.00, status: 'Declined', dueDate: '2025-11-05', description: 'Clogged drain, common area (Duplicate)' },
                    { id: 'i6', contractorId: 'c2', propertyId: 'p1', amount: 780.00, status: 'Pending', dueDate: '2025-11-25', description: 'Parking garage light fixture repair' },
                ],
                nextInvoiceId: 7
            };

            // --- UTILITY FUNCTIONS ---

            /**
             * Formats a number as USD currency.
             * @param {number} amount
             * @returns {string} e.g., $1,250.00
             */
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                }).format(amount);
            };

            /**
             * Formats a date string (YYYY-MM-DD) to a readable format.
             * @param {string} dateString
             * @returns {string} e.g., Nov 20, 2025
             */
            const formatDate = (dateString) => {
                const date = new Date(dateString + 'T00:00:00'); // Ensure correct date parsing
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                });
            };

            /**
             * Returns a Tailwind-based status badge.
             * @param {string} status
             * @returns {string} HTML string for the badge
             */
            const getStatusBadge = (status) => {
                const styles = {
                    'Pending': 'bg-yellow-100 text-yellow-800',
                    'Approved': 'bg-blue-100 text-blue-800',
                    'Paid': 'bg-green-100 text-green-800',
                    'Overdue': 'bg-red-100 text-red-800',
                    'Declined': 'bg-gray-100 text-gray-800',
                };
                return `<span class="inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${styles[status] || styles['Declined']}">${status}</span>`;
            };

            /**
             * Finds an item in state by its ID.
             * @param {string} type - 'contractors', 'properties', 'invoices'
             * @param {string} id
             * @returns {object|undefined}
             */
            const findById = (type, id) => state[type].find(item => item.id === id);


            // --- RENDER FUNCTIONS ---

            /**
             * Renders all page content based on current state.
             */
            const renderAll = () => {
                renderDashboard();
                renderInvoiceTable();
                renderContractorsPage();
                renderPropertiesPage();
                renderModalDropdowns();

                // Update Feather icons
                feather.replace();
            };

            /**
             * Renders the Dashboard KPIs and recent invoices.
             */
            const renderDashboard = () => {
                let overdueAmount = 0, overdueCount = 0;
                let pendingAmount = 0, pendingCount = 0;
                let paidAmount = 0, paidCount = 0;
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                state.invoices.forEach(inv => {
                    const dueDate = new Date(inv.dueDate);
                    if (inv.status === 'Overdue' || (inv.status === 'Pending' && dueDate < now)) {
                        if (inv.status === 'Pending') inv.status = 'Overdue'; // Auto-update status
                        overdueAmount += inv.amount;
                        overdueCount++;
                    } else if (inv.status === 'Pending') {
                        pendingAmount += inv.amount;
                        pendingCount++;
                    } else if (inv.status === 'Paid' && dueDate >= firstDayOfMonth) {
                        paidAmount += inv.amount;
                        paidCount++;
                    }
                });

                document.getElementById('kpi-overdue-amount').textContent = formatCurrency(overdueAmount);
                document.getElementById('kpi-overdue-count').textContent = `${overdueCount} invoices`;
                document.getElementById('kpi-pending-amount').textContent = formatCurrency(pendingAmount);
                document.getElementById('kpi-pending-count').textContent = `${pendingCount} invoices`;
                document.getElementById('kpi-paid-amount').textContent = formatCurrency(paidAmount);
                document.getElementById('kpi-paid-count').textContent = `${paidCount} invoices`;
                document.getElementById('kpi-contractors').textContent = state.contractors.length;

                // Render recent invoices table (top 5)
                const recentInvoices = [...state.invoices]
                    .sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate))
                    .slice(0, 5);
                
                const tableBody = document.getElementById('dashboard-invoice-table');
                if(recentInvoices.length > 0) {
                    tableBody.innerHTML = recentInvoices.map(inv => {
                        const contractor = findById('contractors', inv.contractorId);
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${contractor ? contractor.name : 'Unknown'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(inv.amount)}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(inv.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(inv.dueDate)}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tableBody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-gray-500">No recent invoices.</td></tr>`;
                }
            };

            /**
             * Renders the main Invoices table based on filters.
             */
            const renderInvoiceTable = () => {
                const filter = document.getElementById('invoice-filter').value;
                const filteredInvoices = state.invoices.filter(inv => filter === 'all' || inv.status === filter);
                
                const tableBody = document.getElementById('invoice-table-body');
                
                if (filteredInvoices.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500">No invoices match the filter.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = filteredInvoices.map(inv => {
                    const contractor = findById('contractors', inv.contractorId);
                    const property = findById('properties', inv.propertyId);
                    
                    // Determine actions based on status
                    let actions = '';
                    if (inv.status === 'Pending' || inv.status === 'Overdue') {
                        actions = `
                            <button data-action="approve" data-id="${inv.id}" class="text-indigo-600 hover:text-indigo-900 font-medium">Approve</button>
                            <button data-action="decline" data-id="${inv.id}" class="ml-4 text-red-600 hover:text-red-900 font-medium">Decline</button>
                        `;
                    } else if (inv.status === 'Approved') {
                        actions = `<button data-action="mark-paid" data-id="${inv.id}" class="text-green-600 hover:text-green-900 font-medium">Mark as Paid</button>`;
                    } else if (inv.status === 'Paid') {
                        actions = `<span class="text-sm text-gray-500">Completed</span>`;
                    } else { // Declined
                        actions = `<span class="text-sm text-gray-500">Archived</span>`;
                    }

                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${contractor ? contractor.name : 'Unknown'}</div>
                                <div class="text-sm text-gray-500">${contractor ? contractor.specialty : ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${property ? property.name : 'Unknown'}</div>
                                <div class="text-sm text-gray-500">${property ? property.address : ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate">${inv.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCurrency(inv.amount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(inv.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(inv.dueDate)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actions}</td>
                        </tr>
                    `;
                }).join('');
            };

            /**
             * Renders the Contractors page grid.
             */
            const renderContractorsPage = () => {
                const grid = document.getElementById('contractors-grid');
                grid.innerHTML = state.contractors.map(c => `
                    <div class="rounded-xl bg-white p-6 shadow-lg">
                        <div class="flex items-center space-x-4">
                            <img class="h-16 w-16 rounded-full" src="${c.img}" alt="${c.name}">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${c.name}</h3>
                                <p class="text-sm text-indigo-600 font-medium">${c.specialty}</p>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex items-center text-sm text-gray-600">
                                <i data-feather="mail" class="h-4 w-4 mr-2 text-gray-400"></i>
                                <span>${c.email}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600">
                                <i data-feather="phone" class="h-4 w-4 mr-2 text-gray-400"></i>
                                <span>${c.phone}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            /**
             * Renders the Properties page grid.
             */
            const renderPropertiesPage = () => {
                const grid = document.getElementById('properties-grid');
                grid.innerHTML = state.properties.map(p => `
                    <div class="overflow-hidden rounded-xl bg-white shadow-lg">
                        <img class="h-48 w-full object-cover" src="${p.img}" alt="${p.name}">
                        <div class="p-5">
                            <h3 class="text-lg font-semibold text-gray-900">${p.name}</h3>
                            <p class="mt-1 text-sm text-gray-500">${p.address}</p>
                            <button class="mt-4 w-full rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200">
                                View Invoices
                            </button>
                        </div>
                    </div>
                `).join('');
            };

            /**
             * Populates the <select> dropdowns in the invoice modal.
             */
            const renderModalDropdowns = () => {
                const contractorSelect = document.getElementById('modal-contractor');
                contractorSelect.innerHTML = state.contractors.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
                const propertySelect = document.getElementById('modal-property');
                propertySelect.innerHTML = state.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            };


            // --- EVENT HANDLERS & NAVIGATION ---

            /**
             * Handles page navigation.
             * @param {string} pageId - The ID of the page to show.
             */
            const navigateTo = (pageId) => {
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('hidden');
                });
                // Show target page
                document.getElementById(`page-${pageId}`).classList.remove('hidden');

                // Update nav link active states
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });

                // Update header title
                const title = pageId.charAt(0).toUpperCase() + pageId.slice(1);
                document.getElementById('header-title').textContent = title;

                // Close mobile menu
                closeMobileMenu();

                state.currentPage = pageId;
            };

            // Page navigation listeners
            document.getElementById('desktop-nav').addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('.nav-link');
                if (link && link.dataset.page) {
                    navigateTo(link.dataset.page);
                }
            });
            document.getElementById('mobile-nav').addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('.nav-link');
                if (link && link.dataset.page) {
                    navigateTo(link.dataset.page);
                }
            });
            
            // Mobile Menu controls
            const mobileMenu = document.getElementById('mobile-menu');
            const openMenuBtn = document.getElementById('mobile-menu-button');
            const closeMenuBtn = document.getElementById('mobile-menu-close');
            const overlay = document.getElementById('mobile-overlay');

            const openMobileMenu = () => mobileMenu.style.display = 'flex';
            const closeMobileMenu = () => mobileMenu.style.display = 'none';

            openMenuBtn.addEventListener('click', openMobileMenu);
            closeMenuBtn.addEventListener('click', closeMobileMenu);
            overlay.addEventListener('click', closeMobileMenu);

            // Invoice table action listeners
            document.getElementById('invoice-table-body').addEventListener('click', (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const id = target.dataset.id;
                
                if (!action || !id) return;

                const invoice = findById('invoices', id);
                if (!invoice) return;

                if (action === 'approve') {
                    invoice.status = 'Approved';
                } else if (action === 'decline') {
                    invoice.status = 'Declined';
                } else if (action === 'mark-paid') {
                    invoice.status = 'Paid';
                }

                renderAll(); // Re-render everything to reflect changes
            });

            // Invoice filter listener
            document.getElementById('invoice-filter').addEventListener('change', renderInvoiceTable);

            // --- INVOICE MODAL LOGIC ---

            const modal = document.getElementById('invoice-modal');
            const form = document.getElementById('invoice-form');

            const showModal = () => modal.style.display = 'flex';
            const hideModal = () => {
                modal.style.display = 'none';
                form.reset();
            };

            // Open modal buttons
            document.getElementById('new-invoice-btn').addEventListener('click', showModal);
            document.getElementById('new-invoice-btn-header').addEventListener('click', showModal);

            // Close modal buttons
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            document.getElementById('modal-cancel-btn').addEventListener('click', hideModal);

            // Form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const newInvoice = {
                    id: 'i' + state.nextInvoiceId++,
                    contractorId: document.getElementById('modal-contractor').value,
                    propertyId: document.getElementById('modal-property').value,
                    amount: parseFloat(document.getElementById('modal-amount').value) || 0,
                    status: 'Pending',
                    dueDate: document.getElementById('modal-due-date').value || new Date().toISOString().split('T')[0],
                    description: document.getElementById('modal-description').value || 'No description',
                };

                state.invoices.push(newInvoice);
                
                hideModal();
                renderAll(); // Re-render all data
                navigateTo('invoices'); // Switch to invoices page to see the new entry
            });


            // --- INITIALIZATION ---
            renderAll();
            navigateTo('dashboard'); // Start on the dashboard
        });
    </script>
</body>
</html>
